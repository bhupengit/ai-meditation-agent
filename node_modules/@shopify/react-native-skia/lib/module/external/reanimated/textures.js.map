{"version":3,"names":["useEffect","useState","drawAsPicture","Skia","useImage","Platform","Rea","createTextureFromImage","texture","image","surface","Surface","MakeOffscreen","width","height","value","canvas","getCanvas","drawImage","flush","makeImageSnapshot","OS","makeNonTextureImage","createTexture","picture","size","drawPicture","useTexture","element","deps","setPicture","x","y","then","pic","usePictureAsTexture","useSharedValue","runOnUI","useImageAsTexture","source"],"sources":["textures.tsx"],"sourcesContent":["import { useEffect, useState } from \"react\";\nimport type { DependencyList, ReactElement } from \"react\";\nimport type { SharedValue } from \"react-native-reanimated\";\n\nimport type {\n  DataSourceParam,\n  SkImage,\n  SkPicture,\n  SkSize,\n} from \"../../skia/types\";\nimport { drawAsPicture } from \"../../renderer/Offscreen\";\nimport { Skia, useImage } from \"../../skia\";\nimport { Platform } from \"../../Platform\";\n\nimport Rea from \"./ReanimatedProxy\";\n\nconst createTextureFromImage = (\n  texture: SharedValue<SkImage | null>,\n  image: SkImage\n) => {\n  \"worklet\";\n  const surface = Skia.Surface.MakeOffscreen(image.width(), image.height());\n  if (!surface) {\n    texture.value = null;\n    return;\n  }\n  const canvas = surface.getCanvas();\n  canvas.drawImage(image, 0, 0);\n  surface.flush();\n  texture.value = surface.makeImageSnapshot();\n  if (Platform.OS === \"web\") {\n    texture.value = texture.value.makeNonTextureImage();\n  }\n};\n\nconst createTexture = (\n  texture: SharedValue<SkImage | null>,\n  picture: SkPicture,\n  size: SkSize\n) => {\n  \"worklet\";\n  const surface = Skia.Surface.MakeOffscreen(size.width, size.height)!;\n  const canvas = surface.getCanvas();\n  canvas.drawPicture(picture);\n  surface.flush();\n  texture.value = surface.makeImageSnapshot();\n  if (Platform.OS === \"web\") {\n    texture.value = texture.value.makeNonTextureImage();\n  }\n};\n\nexport const useTexture = (\n  element: ReactElement,\n  size: SkSize,\n  deps?: DependencyList\n) => {\n  const { width, height } = size;\n  const [picture, setPicture] = useState<SkPicture | null>(null);\n  useEffect(() => {\n    drawAsPicture(element, {\n      x: 0,\n      y: 0,\n      width,\n      height,\n    }).then((pic) => {\n      setPicture(pic);\n    });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, deps ?? []);\n  return usePictureAsTexture(picture, size);\n};\n\nexport const usePictureAsTexture = (\n  picture: SkPicture | null,\n  size: SkSize\n) => {\n  const texture = Rea.useSharedValue<SkImage | null>(null);\n  useEffect(() => {\n    if (picture !== null) {\n      Rea.runOnUI(createTexture)(texture, picture, size);\n    }\n  }, [picture, size, texture]);\n  return texture;\n};\n\nexport const useImageAsTexture = (source: DataSourceParam) => {\n  const image = useImage(source);\n  const texture = Rea.useSharedValue<SkImage | null>(null);\n  useEffect(() => {\n    if (image !== null) {\n      Rea.runOnUI(createTextureFromImage)(texture, image);\n    }\n  }, [image, texture]);\n  return texture;\n};\n"],"mappings":"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","ignoreList":[]}