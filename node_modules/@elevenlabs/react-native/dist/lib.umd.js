!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("react"),require("@livekit/react-native")):"function"==typeof define&&define.amd?define(["exports","react","@livekit/react-native"],n):n((e||self).reactNative={},e.react,e.reactNative)}(this,function(e,n,t){function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=/*#__PURE__*/o(n);function a(){return a=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)({}).hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},a.apply(null,arguments)}var c="0.5.1",l=function(e){var o=e.onReady,a=e.isConnected,c=e.callbacks,l=e.sendMessage,i=e.clientTools,s=void 0===i?{}:i,u=e.updateCurrentEventId,d=t.useLocalParticipant().localParticipant,v=r.default.useRef(1);return n.useEffect(function(){a&&d&&o(d)},[a,d,o]),t.useDataChannel(function(e){var n,t=new TextDecoder,o=JSON.parse(t.decode(e.payload));if("object"==typeof(r=o)&&null!==r&&"type"in r){var r,a,i=function(e){switch(e.type){case"user_transcript":return e.user_transcription_event.user_transcript;case"agent_response":return e.agent_response_event.agent_response;default:return null}}(o);if(null!==i&&(null==c.onMessage||c.onMessage({message:i,source:"user_transcript"===o.type?"user":"ai"})),null!=(n=e.from)&&n.isAgent&&(null==c.onModeChange||c.onModeChange({mode:null!=(a=e.from)&&a.isSpeaking?"speaking":"listening"}),"agent_response"===o.type&&u)){var d=v.current++;u(d)}switch(o.type){case"ping":l({type:"pong",event_id:o.ping_event.event_id});break;case"client_tool_call":!function(e){try{return Promise.resolve(function(){if(e.client_tool_call.tool_name in s){var n=function(n,t){try{var o=Promise.resolve(s[e.client_tool_call.tool_name](e.client_tool_call.parameters)).then(function(n){var t="object"==typeof n?JSON.stringify(n):String(n);l({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:t,is_error:!1})})}catch(e){return t(e)}return o&&o.then?o.then(void 0,t):o}(0,function(n){null==c.onError||c.onError("Client tool execution failed with following error: "+(null==n?void 0:n.message),{clientToolName:e.client_tool_call.tool_name}),l({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:"Client tool execution failed: "+(null==n?void 0:n.message),is_error:!0})});if(n&&n.then)return n.then(function(){})}else{if(c.onUnhandledClientToolCall)return void c.onUnhandledClientToolCall(e.client_tool_call);var t="Client tool with name "+e.client_tool_call.tool_name+" is not defined on client";null==c.onError||c.onError(t,{clientToolName:e.client_tool_call.tool_name}),l({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:t,is_error:!0})}}())}catch(e){return Promise.reject(e)}}(o);break;case"audio":null==c.onAudio||c.onAudio(o.audio_event.audio_base_64);break;case"vad_score":null==c.onVadScore||c.onVadScore({vadScore:o.vad_score_event.vad_score});break;case"interruption":null==c.onInterruption||c.onInterruption(o.interruption_event);break;case"mcp_tool_call":null==c.onMCPToolCall||c.onMCPToolCall(o.mcp_tool_call);break;case"mcp_connection_status":null==c.onMCPConnectionStatus||c.onMCPConnectionStatus(o.mcp_connection_status);break;case"agent_tool_response":null==c.onAgentToolResponse||c.onAgentToolResponse(o.agent_tool_response);break;case"conversation_initiation_metadata":null==c.onConversationMetadata||c.onConversationMetadata(o.conversation_initiation_metadata_event);break;case"asr_initiation_metadata":null==c.onAsrInitiationMetadata||c.onAsrInitiationMetadata(o.asr_initiation_metadata_event);break;case"agent_chat_response_part":null==c.onAgentChatResponsePart||c.onAgentChatResponsePart(o.text_response_part);break;default:null==c.onDebug||c.onDebug(o)}}else null==c.onDebug||c.onDebug({type:"invalid_event",message:o})}),null},i=function(e){var n=e.children;/*#__PURE__*/return r.default.createElement(t.LiveKitRoom,{serverUrl:e.serverUrl,token:e.token,connect:e.connect,audio:!0,video:!1,options:{adaptiveStream:{pixelDensity:"screen"}},onConnected:e.onConnected,onDisconnected:e.onDisconnected,onError:e.onError},/*#__PURE__*/r.default.createElement(l,{onReady:e.onParticipantReady,isConnected:e.roomConnected,callbacks:e.callbacks,sendMessage:e.sendMessage,clientTools:e.clientTools,updateCurrentEventId:e.updateCurrentEventId}),n)},s=["serverUrl","tokenFetchUrl","clientTools"],u=/*#__PURE__*/n.createContext(null);e.ElevenLabsProvider=function(e){var o=e.children;t.registerGlobals();var l=n.useState(""),s=l[0],d=l[1],v=n.useState(!1),f=v[0],_=v[1],p=n.useState("disconnected"),h=p[0],m=p[1],g=n.useState("wss://livekit.rtc.elevenlabs.io"),C=g[0],b=g[1],k=n.useState(void 0),y=k[0],S=k[1],E=n.useState(""),P=E[0],T=E[1],x=n.useState(!1),w=x[0],M=x[1],I=n.useState(!1),R=I[0],D=I[1],U=r.default.useRef(1),F=r.default.useRef(1),A=r.default.useRef({}),j=function(){var e=n.useRef({}),t=n.useCallback(function(n){e.current=n},[]);return{callbacksRef:e,setCallbacks:t}}(),L=j.callbacksRef,N=j.setCallbacks,O=r.default.useCallback(function(e){var n=a({},e,{onModeChange:function(n){M("speaking"===n.mode),null==e.onModeChange||e.onModeChange(n)}});N(n)},[N]),V=function(e,t,o,r,a,l){var i=n.useState({}),s=i[0],u=i[1],d=n.useState(null),v=d[0],f=d[1],_=n.useState({}),p=_[0],h=_[1],m=n.useState(void 0),g=m[0],C=m[1];return{startSession:n.useCallback(function(n){try{return Promise.resolve(function(i,s){try{var d=function(){function i(e){var n=function(e){try{var n,t;return(null==(t=((null==(n=JSON.parse(atob(e.split(".")[1])).video)?void 0:n.room)||"").match(/(conv_[a-zA-Z0-9]+)/))?void 0:t[0])||""}catch(e){return console.warn("Could not extract conversation ID from token"),""}}(s);a(n),r(s),o(!0)}var s;t("connecting"),null==e.current.onStatusChange||e.current.onStatusChange({status:"connecting"}),u(n.overrides||{}),f(n.customLlmExtraBody||null),h(n.dynamicVariables||{}),C(n.userId);var d=function(){if(!n.conversationToken)return function(){if(n.agentId)return console.info("Getting conversation token for agentId:",n.agentId),Promise.resolve(function(e,n){try{return Promise.resolve(fetch((n||"https://api.elevenlabs.io/v1/convai/conversation/token")+"?agent_id="+e+"&source=react_native_sdk&version="+c)).then(function(e){return Promise.resolve(e.json()).then(function(n){if(!e.ok)throw new Error("Failed to get conversation token: "+n.detail.message);if(!n.token)throw new Error("No conversation token received from API");return n.token})})}catch(e){return Promise.reject(e)}}(n.agentId,n.tokenFetchUrl||l)).then(function(e){s=e});throw new Error("Either conversationToken or agentId is required")}();s=n.conversationToken}();return d&&d.then?d.then(i):i()}()}catch(e){return s(e)}return d&&d.then?d.then(void 0,s):d}(0,function(n){throw t("disconnected"),null==e.current.onStatusChange||e.current.onStatusChange({status:"disconnected"}),null==e.current.onError||e.current.onError(n),n}))}catch(e){return Promise.reject(e)}},[e,t,o,r,a,l]),endSession:n.useCallback(function(){try{try{o(!1),r(""),t("disconnected"),null==e.current.onStatusChange||e.current.onStatusChange({status:"disconnected"}),null==e.current.onDisconnect||e.current.onDisconnect({reason:"user"})}catch(n){throw null==e.current.onError||e.current.onError(n),n}return Promise.resolve()}catch(e){return Promise.reject(e)}},[e,o,r,t]),overrides:s,customLlmExtraBody:v,dynamicVariables:p,userId:g}}(L,m,_,d,T,y),B=V.startSession,J=V.endSession,q=V.overrides,K=V.customLlmExtraBody,G=V.dynamicVariables,z=V.userId,W=function(e,o,r){var a=n.useState(!1),c=a[0],l=a[1],i=n.useState(null),s=i[0],u=i[1],d=n.useRef(!1);n.useEffect(function(){return function(){try{return Promise.resolve(t.AudioSession.startAudioSession()).then(function(){})}catch(e){return Promise.reject(e)}}(),function(){t.AudioSession.stopAudioSession()}},[]),n.useEffect(function(){s&&c&&!d.current&&(d.current=!0,null==e.current.onConnect||e.current.onConnect({conversationId:r}))},[s,c,r,e]);var v=n.useCallback(function(e){s||(u(e),o("connected"))},[s,o]),f=n.useCallback(function(){l(!0)},[]),_=n.useCallback(function(){l(!1),o("disconnected"),u(null),d.current=!1,null==e.current.onDisconnect||e.current.onDisconnect({reason:"user"})},[e,o]),p=n.useCallback(function(n){console.error("LiveKit error:",n),null==e.current.onError||e.current.onError(n.message,void 0)},[e]);return{roomConnected:c,localParticipant:s,handleParticipantReady:v,handleConnected:f,handleDisconnected:_,handleError:p}}(L,m,P),Z=W.roomConnected,H=W.localParticipant,Q=W.handleParticipantReady,X=W.handleConnected,Y=W.handleDisconnected,$=W.handleError,ee=r.default.useCallback(function(){U.current=1,F.current=1,D(!1),null==L.current.onCanSendFeedbackChange||L.current.onCanSendFeedbackChange({canSendFeedback:!1}),X()},[X,L]),ne=r.default.useCallback(function(){D(!1),Y()},[Y]),te=function(e,t,o){return{sendMessage:n.useCallback(function(n){try{if("connected"!==e||!t)return console.warn("Cannot send message: room not connected or no local participant"),Promise.resolve();var r=function(e,o){try{var r=(a=(new TextEncoder).encode(JSON.stringify(n)),Promise.resolve(t.publishData(a,{reliable:!0})).then(function(){}))}catch(e){return o(e)}var a;return r&&r.then?r.then(void 0,o):r}(0,function(e){console.error("Failed to send message via WebRTC:",e),console.error("Error details:",e),null==o.current.onError||o.current.onError(e)});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},[e,t,o])}}(h,H,L),oe=te.sendMessage,re=r.default.useCallback(function(){var e=U.current!==F.current;R!==e&&(D(e),null==L.current.onCanSendFeedbackChange||L.current.onCanSendFeedbackChange({canSendFeedback:e}))},[R,L]),ae=r.default.useCallback(function(e){R?(oe({type:"feedback",score:e?"like":"dislike",event_id:U.current}),F.current=U.current,re()):console.warn(0===F.current?"Cannot send feedback: the conversation has not started yet.":"Cannot send feedback: feedback has already been sent for the current response.")},[R,oe,re]);r.default.useCallback(function(e){console.warn("setVolume is not yet implemented in React Native SDK")},[]);var ce=r.default.useCallback(function(e){H&&H.setMicrophoneEnabled(!e)},[H]),le=r.default.useCallback(function(e){U.current=e,re()},[re]),ie=r.default.useCallback(function(e){Q(e);var n=function(e){var n,t,o,r,a,l,i={type:"conversation_initiation_client_data"};return e.overrides&&(i.conversation_config_override={agent:{prompt:null==(t=e.overrides.agent)?void 0:t.prompt,first_message:null==(o=e.overrides.agent)?void 0:o.firstMessage,language:null==(r=e.overrides.agent)?void 0:r.language},tts:{voice_id:null==(a=e.overrides.tts)?void 0:a.voiceId},conversation:{text_only:null==(l=e.overrides.conversation)?void 0:l.textOnly}}),i.source_info={source:"react_native_sdk",version:(null==(n=e.overrides)||null==(n=n.client)?void 0:n.version)||c},e.customLlmExtraBody&&(i.custom_llm_extra_body=e.customLlmExtraBody),e.dynamicVariables&&(i.dynamic_variables=e.dynamicVariables),e.userId&&(i.user_id=String(e.userId)),i}({overrides:q,customLlmExtraBody:K,dynamicVariables:G,userId:z});if(n)try{var t=(new TextEncoder).encode(JSON.stringify(n));e.publishData(t,{reliable:!0})}catch(e){console.error("Failed to send overrides:",e),null==L.current.onError||L.current.onError(e)}},[Q,q,K,G,z,L]),se={startSession:B,endSession:J,status:h,isSpeaking:w,canSendFeedback:R,getId:function(){return P},setMicMuted:ce,sendFeedback:ae,sendContextualUpdate:function(e){oe({type:"contextual_update",text:e})},sendUserMessage:function(e){oe({type:"user_message",text:e})},sendUserActivity:function(){oe({type:"user_activity"})}},ue=r.default.useCallback(function(e){A.current=e},[]);/*#__PURE__*/return r.default.createElement(u.Provider,{value:{conversation:se,callbacksRef:L,serverUrl:C,tokenFetchUrl:y,clientTools:A.current,setCallbacks:O,setServerUrl:b,setTokenFetchUrl:S,setClientTools:ue}},/*#__PURE__*/r.default.createElement(i,{serverUrl:C,token:s,connect:f,onConnected:ee,onDisconnected:ne,onError:$,roomConnected:Z,callbacks:L.current,onParticipantReady:ie,sendMessage:oe,clientTools:A.current,updateCurrentEventId:le},o))},e.useConversation=function(e){void 0===e&&(e={});var t=n.useContext(u);if(!t)throw new Error("useConversation must be used within ElevenLabsProvider");var o=e.serverUrl,a=e.tokenFetchUrl,c=e.clientTools,l=function(e,n){if(null==e)return{};var t={};for(var o in e)if({}.hasOwnProperty.call(e,o)){if(-1!==n.indexOf(o))continue;t[o]=e[o]}return t}(e,s);return r.default.useEffect(function(){o&&t.setServerUrl(o)},[t,o]),r.default.useEffect(function(){a&&t.setTokenFetchUrl(a)},[t,a]),c&&t.setClientTools(c),t.setCallbacks(l),t.conversation}});
//# sourceMappingURL=lib.umd.js.map
