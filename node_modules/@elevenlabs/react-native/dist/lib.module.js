import e,{useRef as n,useCallback as t,useState as r,useEffect as o,useContext as a,createContext as c}from"react";import{AudioSession as i,useLocalParticipant as l,useDataChannel as s,LiveKitRoom as u,registerGlobals as d}from"@livekit/react-native";function v(){return v=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)({}).hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},v.apply(null,arguments)}var f="0.5.1",_=function(n){var t=n.onReady,r=n.isConnected,a=n.callbacks,c=n.sendMessage,i=n.clientTools,u=void 0===i?{}:i,d=n.updateCurrentEventId,v=l().localParticipant,f=e.useRef(1);return o(function(){r&&v&&t(v)},[r,v,t]),s(function(e){var n,t=new TextDecoder,r=JSON.parse(t.decode(e.payload));if("object"==typeof(o=r)&&null!==o&&"type"in o){var o,i,l=function(e){switch(e.type){case"user_transcript":return e.user_transcription_event.user_transcript;case"agent_response":return e.agent_response_event.agent_response;default:return null}}(r);if(null!==l&&(null==a.onMessage||a.onMessage({message:l,source:"user_transcript"===r.type?"user":"ai"})),null!=(n=e.from)&&n.isAgent&&(null==a.onModeChange||a.onModeChange({mode:null!=(i=e.from)&&i.isSpeaking?"speaking":"listening"}),"agent_response"===r.type&&d)){var s=f.current++;d(s)}switch(r.type){case"ping":c({type:"pong",event_id:r.ping_event.event_id});break;case"client_tool_call":!function(e){try{return Promise.resolve(function(){if(e.client_tool_call.tool_name in u){var n=function(n,t){try{var r=Promise.resolve(u[e.client_tool_call.tool_name](e.client_tool_call.parameters)).then(function(n){var t="object"==typeof n?JSON.stringify(n):String(n);c({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:t,is_error:!1})})}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}(0,function(n){null==a.onError||a.onError("Client tool execution failed with following error: "+(null==n?void 0:n.message),{clientToolName:e.client_tool_call.tool_name}),c({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:"Client tool execution failed: "+(null==n?void 0:n.message),is_error:!0})});if(n&&n.then)return n.then(function(){})}else{if(a.onUnhandledClientToolCall)return void a.onUnhandledClientToolCall(e.client_tool_call);var t="Client tool with name "+e.client_tool_call.tool_name+" is not defined on client";null==a.onError||a.onError(t,{clientToolName:e.client_tool_call.tool_name}),c({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:t,is_error:!0})}}())}catch(e){return Promise.reject(e)}}(r);break;case"audio":null==a.onAudio||a.onAudio(r.audio_event.audio_base_64);break;case"vad_score":null==a.onVadScore||a.onVadScore({vadScore:r.vad_score_event.vad_score});break;case"interruption":null==a.onInterruption||a.onInterruption(r.interruption_event);break;case"mcp_tool_call":null==a.onMCPToolCall||a.onMCPToolCall(r.mcp_tool_call);break;case"mcp_connection_status":null==a.onMCPConnectionStatus||a.onMCPConnectionStatus(r.mcp_connection_status);break;case"agent_tool_response":null==a.onAgentToolResponse||a.onAgentToolResponse(r.agent_tool_response);break;case"conversation_initiation_metadata":null==a.onConversationMetadata||a.onConversationMetadata(r.conversation_initiation_metadata_event);break;case"asr_initiation_metadata":null==a.onAsrInitiationMetadata||a.onAsrInitiationMetadata(r.asr_initiation_metadata_event);break;case"agent_chat_response_part":null==a.onAgentChatResponsePart||a.onAgentChatResponsePart(r.text_response_part);break;default:null==a.onDebug||a.onDebug(r)}}else null==a.onDebug||a.onDebug({type:"invalid_event",message:r})}),null},m=function(n){var t=n.children;/*#__PURE__*/return e.createElement(u,{serverUrl:n.serverUrl,token:n.token,connect:n.connect,audio:!0,video:!1,options:{adaptiveStream:{pixelDensity:"screen"}},onConnected:n.onConnected,onDisconnected:n.onDisconnected,onError:n.onError},/*#__PURE__*/e.createElement(_,{onReady:n.onParticipantReady,isConnected:n.roomConnected,callbacks:n.callbacks,sendMessage:n.sendMessage,clientTools:n.clientTools,updateCurrentEventId:n.updateCurrentEventId}),t)},p=["serverUrl","tokenFetchUrl","clientTools"],h=/*#__PURE__*/c(null),g=function(n){void 0===n&&(n={});var t=a(h);if(!t)throw new Error("useConversation must be used within ElevenLabsProvider");var r=n.serverUrl,o=n.tokenFetchUrl,c=n.clientTools,i=function(e,n){if(null==e)return{};var t={};for(var r in e)if({}.hasOwnProperty.call(e,r)){if(-1!==n.indexOf(r))continue;t[r]=e[r]}return t}(n,p);return e.useEffect(function(){r&&t.setServerUrl(r)},[t,r]),e.useEffect(function(){o&&t.setTokenFetchUrl(o)},[t,o]),c&&t.setClientTools(c),t.setCallbacks(i),t.conversation},C=function(a){var c=a.children;d();var l=r(""),s=l[0],u=l[1],_=r(!1),p=_[0],g=_[1],C=r("disconnected"),b=C[0],k=C[1],y=r("wss://livekit.rtc.elevenlabs.io"),E=y[0],S=y[1],P=r(void 0),w=P[0],M=P[1],T=r(""),I=T[0],x=T[1],D=r(!1),R=D[0],U=D[1],F=r(!1),A=F[0],j=F[1],O=e.useRef(1),N=e.useRef(1),V=e.useRef({}),L=function(){var e=n({}),r=t(function(n){e.current=n},[]);return{callbacksRef:e,setCallbacks:r}}(),B=L.callbacksRef,J=L.setCallbacks,K=e.useCallback(function(e){var n=v({},e,{onModeChange:function(n){U("speaking"===n.mode),null==e.onModeChange||e.onModeChange(n)}});J(n)},[J]),q=function(e,n,o,a,c,i){var l=r({}),s=l[0],u=l[1],d=r(null),v=d[0],_=d[1],m=r({}),p=m[0],h=m[1],g=r(void 0),C=g[0],b=g[1];return{startSession:t(function(t){try{return Promise.resolve(function(r,l){try{var s=function(){function r(e){var n=function(e){try{var n,t;return(null==(t=((null==(n=JSON.parse(atob(e.split(".")[1])).video)?void 0:n.room)||"").match(/(conv_[a-zA-Z0-9]+)/))?void 0:t[0])||""}catch(e){return console.warn("Could not extract conversation ID from token"),""}}(l);c(n),a(l),o(!0)}var l;n("connecting"),null==e.current.onStatusChange||e.current.onStatusChange({status:"connecting"}),u(t.overrides||{}),_(t.customLlmExtraBody||null),h(t.dynamicVariables||{}),b(t.userId);var s=function(){if(!t.conversationToken)return function(){if(t.agentId)return console.info("Getting conversation token for agentId:",t.agentId),Promise.resolve(function(e,n){try{return Promise.resolve(fetch((n||"https://api.elevenlabs.io/v1/convai/conversation/token")+"?agent_id="+e+"&source=react_native_sdk&version="+f)).then(function(e){return Promise.resolve(e.json()).then(function(n){if(!e.ok)throw new Error("Failed to get conversation token: "+n.detail.message);if(!n.token)throw new Error("No conversation token received from API");return n.token})})}catch(e){return Promise.reject(e)}}(t.agentId,t.tokenFetchUrl||i)).then(function(e){l=e});throw new Error("Either conversationToken or agentId is required")}();l=t.conversationToken}();return s&&s.then?s.then(r):r()}()}catch(e){return l(e)}return s&&s.then?s.then(void 0,l):s}(0,function(t){throw n("disconnected"),null==e.current.onStatusChange||e.current.onStatusChange({status:"disconnected"}),null==e.current.onError||e.current.onError(t),t}))}catch(e){return Promise.reject(e)}},[e,n,o,a,c,i]),endSession:t(function(){try{try{o(!1),a(""),n("disconnected"),null==e.current.onStatusChange||e.current.onStatusChange({status:"disconnected"}),null==e.current.onDisconnect||e.current.onDisconnect({reason:"user"})}catch(n){throw null==e.current.onError||e.current.onError(n),n}return Promise.resolve()}catch(e){return Promise.reject(e)}},[e,o,a,n]),overrides:s,customLlmExtraBody:v,dynamicVariables:p,userId:C}}(B,k,g,u,x,w),z=q.startSession,G=q.endSession,W=q.overrides,Z=q.customLlmExtraBody,H=q.dynamicVariables,Q=q.userId,X=function(e,a,c){var l=r(!1),s=l[0],u=l[1],d=r(null),v=d[0],f=d[1],_=n(!1);o(function(){return function(){try{return Promise.resolve(i.startAudioSession()).then(function(){})}catch(e){return Promise.reject(e)}}(),function(){i.stopAudioSession()}},[]),o(function(){v&&s&&!_.current&&(_.current=!0,null==e.current.onConnect||e.current.onConnect({conversationId:c}))},[v,s,c,e]);var m=t(function(e){v||(f(e),a("connected"))},[v,a]),p=t(function(){u(!0)},[]),h=t(function(){u(!1),a("disconnected"),f(null),_.current=!1,null==e.current.onDisconnect||e.current.onDisconnect({reason:"user"})},[e,a]),g=t(function(n){console.error("LiveKit error:",n),null==e.current.onError||e.current.onError(n.message,void 0)},[e]);return{roomConnected:s,localParticipant:v,handleParticipantReady:m,handleConnected:p,handleDisconnected:h,handleError:g}}(B,k,I),Y=X.roomConnected,$=X.localParticipant,ee=X.handleParticipantReady,ne=X.handleConnected,te=X.handleDisconnected,re=X.handleError,oe=e.useCallback(function(){O.current=1,N.current=1,j(!1),null==B.current.onCanSendFeedbackChange||B.current.onCanSendFeedbackChange({canSendFeedback:!1}),ne()},[ne,B]),ae=e.useCallback(function(){j(!1),te()},[te]),ce=function(e,n,r){return{sendMessage:t(function(t){try{if("connected"!==e||!n)return console.warn("Cannot send message: room not connected or no local participant"),Promise.resolve();var o=function(e,r){try{var o=(a=(new TextEncoder).encode(JSON.stringify(t)),Promise.resolve(n.publishData(a,{reliable:!0})).then(function(){}))}catch(e){return r(e)}var a;return o&&o.then?o.then(void 0,r):o}(0,function(e){console.error("Failed to send message via WebRTC:",e),console.error("Error details:",e),null==r.current.onError||r.current.onError(e)});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},[e,n,r])}}(b,$,B),ie=ce.sendMessage,le=e.useCallback(function(){var e=O.current!==N.current;A!==e&&(j(e),null==B.current.onCanSendFeedbackChange||B.current.onCanSendFeedbackChange({canSendFeedback:e}))},[A,B]),se=e.useCallback(function(e){A?(ie({type:"feedback",score:e?"like":"dislike",event_id:O.current}),N.current=O.current,le()):console.warn(0===N.current?"Cannot send feedback: the conversation has not started yet.":"Cannot send feedback: feedback has already been sent for the current response.")},[A,ie,le]);e.useCallback(function(e){console.warn("setVolume is not yet implemented in React Native SDK")},[]);var ue=e.useCallback(function(e){$&&$.setMicrophoneEnabled(!e)},[$]),de=e.useCallback(function(e){O.current=e,le()},[le]),ve=e.useCallback(function(e){ee(e);var n=function(e){var n,t,r,o,a,c,i={type:"conversation_initiation_client_data"};return e.overrides&&(i.conversation_config_override={agent:{prompt:null==(t=e.overrides.agent)?void 0:t.prompt,first_message:null==(r=e.overrides.agent)?void 0:r.firstMessage,language:null==(o=e.overrides.agent)?void 0:o.language},tts:{voice_id:null==(a=e.overrides.tts)?void 0:a.voiceId},conversation:{text_only:null==(c=e.overrides.conversation)?void 0:c.textOnly}}),i.source_info={source:"react_native_sdk",version:(null==(n=e.overrides)||null==(n=n.client)?void 0:n.version)||f},e.customLlmExtraBody&&(i.custom_llm_extra_body=e.customLlmExtraBody),e.dynamicVariables&&(i.dynamic_variables=e.dynamicVariables),e.userId&&(i.user_id=String(e.userId)),i}({overrides:W,customLlmExtraBody:Z,dynamicVariables:H,userId:Q});if(n)try{var t=(new TextEncoder).encode(JSON.stringify(n));e.publishData(t,{reliable:!0})}catch(e){console.error("Failed to send overrides:",e),null==B.current.onError||B.current.onError(e)}},[ee,W,Z,H,Q,B]),fe={startSession:z,endSession:G,status:b,isSpeaking:R,canSendFeedback:A,getId:function(){return I},setMicMuted:ue,sendFeedback:se,sendContextualUpdate:function(e){ie({type:"contextual_update",text:e})},sendUserMessage:function(e){ie({type:"user_message",text:e})},sendUserActivity:function(){ie({type:"user_activity"})}},_e=e.useCallback(function(e){V.current=e},[]);/*#__PURE__*/return e.createElement(h.Provider,{value:{conversation:fe,callbacksRef:B,serverUrl:E,tokenFetchUrl:w,clientTools:V.current,setCallbacks:K,setServerUrl:S,setTokenFetchUrl:M,setClientTools:_e}},/*#__PURE__*/e.createElement(m,{serverUrl:E,token:s,connect:p,onConnected:oe,onDisconnected:ae,onError:re,roomConnected:Y,callbacks:B.current,onParticipantReady:ve,sendMessage:ie,clientTools:V.current,updateCurrentEventId:de},c))};export{C as ElevenLabsProvider,g as useConversation};
//# sourceMappingURL=lib.module.js.map
